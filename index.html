
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Cozy Farm – Tilemap Prototype</title>
<script>
(function() {
  var s=document.createElement('script');
  s.src="https://unpkg.com/phaser@3.55.2/dist/phaser.min.js";
  s.onload=function(){ console.log('Phaser OK'); };
  s.onerror=function(){
    var s2=document.createElement('script');
    s2.src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js";
    document.head.appendChild(s2);
  };
  document.head.appendChild(s);
})();
</script>
<style>
  html,body { margin:0; height:100%; background:#132014; }
  #game { width:100%; height:100%; display:block; touch-action:none; }
  #hud { position:fixed; left:10px; top:10px; color:#e9ffe9; font:14px system-ui; z-index:10; display:flex; gap:8px; flex-wrap:wrap; }
  .chip { background:rgba(30,45,30,.8); padding:6px 8px; border-radius:10px; }
  #prompt { position:fixed; bottom:calc(88px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); color:#e9ffe9; background:rgba(0,0,0,.45); padding:8px 12px; border-radius:12px; z-index:10; font:14px system-ui; }
  #controls { position:fixed; left:0; right:0; bottom:0; height:180px; padding:16px env(safe-area-inset-right) calc(16px + env(safe-area-inset-bottom)) env(safe-area-inset-left); display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none; z-index:20; }
  #joy { width:140px; height:140px; border-radius:50%; background:rgba(40,60,40,.45); border:1px solid #2d402d; position:relative; margin-left:8px; pointer-events:auto; }
  #stick { position:absolute; left:50%; top:50%; width:64px; height:64px; margin:-32px; border-radius:50%; background:rgba(90,140,90,.85); border:2px solid #1d2d1d; }
  #btns { display:flex; gap:12px; pointer-events:auto; margin-right:8px; }
  .btn { width:72px; height:72px; border-radius:50%; background:rgba(70,100,70,.9); border:2px solid #233523; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; color:#e9ffe9; }
  .btn.small { width:60px; height:60px; font-size:16px; opacity:.9; }
</style>
</head>
<body>
<div id="hud">
  <div class="chip" id="cDay">Tag 1</div>
  <div class="chip" id="cTime">Zeit 8.0h</div>
  <div class="chip" id="cInv">Samen 6 • Holz 3 • Münzen 0</div>
</div>
<div id="prompt"></div>
<div id="controls">
  <div id="joy"><div id="stick"></div></div>
  <div id="btns">
    <div class="btn" id="bInteract">E</div>
    <div class="btn" id="bUse">●</div>
    <div class="btn small" id="bSleep">⏭</div>
  </div>
</div>
<canvas id="game"></canvas>
  
<script>
  (function(){
    function bubble(msg){
      const d=document.createElement('div');
      d.style.cssText='position:fixed;left:12px;bottom:12px;background:#a33;color:#fff;padding:8px 10px;border-radius:8px;z-index:9999;max-width:80vw';
      d.textContent=msg;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(), 6000);
    }
    window.addEventListener('error', e => bubble('JS-Fehler: '+(e.message||e.filename)));
    window.addEventListener('unhandledrejection', e => bubble('Promise-Fehler: '+e.reason));
    setTimeout(()=>{ if(!window.Phaser) bubble('Phaser wurde nicht geladen (CDN geblockt?)'); },2000);
  })();
</script>
  
<script>
const config = {
  type: Phaser.AUTO,
  canvas: document.getElementById('game'),
  scale: { mode: Phaser.Scale.RESIZE, width: '100%', height: '100%' },
  physics: { default: 'arcade', arcade: { gravity: {y:0}, debug:false } },
  render: { pixelArt: true, antialias: false },
  scene: { preload, create, update }
};
let game = new Phaser.Game(config);

let player, cursors, map, fields, collision, cam, joyVec={x:0,y:0};
let day=1, timeOfDay=8.0, seeds=6, wood=3, coins=0;
const promptEl = document.getElementById('prompt');

function preload(){
  this.load.image('tiles', 'tiles.png');
  this.load.tilemapTiledJSON('map', 'map.json');
}

function create(){
  map = this.make.tilemap({ key:'map' });
  const tiles = map.addTilesetImage('tiles', 'tiles', map.tileWidth, map.tileHeight, 0, 0);
  map.createLayer('ground', tiles, 0, 0);
  fields = map.createLayer('fields', tiles, 0, 0);
  map.createLayer('house', tiles, 0, 0);
  collision = map.createLayer('collision', tiles, 0, 0);
  collision.setCollisionBetween(1, 999);

  const objs = map.getObjectLayer('objects').objects;
  const spawn = objs.find(o=>o.type==='spawn');
  player = this.add.rectangle(spawn.x, spawn.y, 10, 14, 0x2b3f71);
  this.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);
  this.physics.add.collider(player, collision);

  cam = this.cameras.main;
  cam.startFollow(player, true, 0.12, 0.12);
  cam.setZoom(3);

  cursors = this.input.keyboard.createCursorKeys();
  this.input.keyboard.addKeys('W,A,S,D');

  setupJoystick();

  document.getElementById('bUse').onclick = ()=>useAction.call(this);
  document.getElementById('bInteract').onclick = ()=>interactAction.call(this);
  document.getElementById('bSleep').onclick = ()=>{ day++; timeOfDay=8; updateHUD(); };

  updateHUD();
}

function setupJoystick(){
  const joy = document.getElementById('joy'), stick = document.getElementById('stick');
  let active=false, base={x:0,y:0};
  function start(x,y){ active=true; const r=joy.getBoundingClientRect(); base.x=r.left+r.width/2; base.y=r.top+r.height/2; move(x,y); }
  function move(x,y){ if(!active) return; const dx=x-base.x, dy=y-base.y; const max=50; const len=Math.hypot(dx,dy); const s = len>max?max/len:1; const sx=dx*s, sy=dy*s; stick.style.transform='translate('+sx+'px,'+sy+'px)'; joyVec.x=dx/max; joyVec.y=dy/max; const m=Math.hypot(joyVec.x,joyVec.y); if(m>1){ joyVec.x/=m; joyVec.y/=m; } }
  function end(){ active=false; stick.style.transform='translate(0,0)'; joyVec.x=joyVec.y=0; }
  joy.addEventListener('touchstart', e=>{const t=e.changedTouches[0]; start(t.clientX,t.clientY); e.preventDefault();},{passive:false});
  joy.addEventListener('touchmove', e=>{const t=e.changedTouches[0]; move(t.clientX,t.clientY); e.preventDefault();},{passive:false});
  joy.addEventListener('touchend', end);
  joy.addEventListener('mousedown', e=> start(e.clientX,e.clientY));
  window.addEventListener('mousemove', e=> move(e.clientX,e.clientY));
  window.addEventListener('mouseup', end);
}

function getHoverObject(){
  const objs = map.getObjectLayer('objects').objects;
  const rect = new Phaser.Geom.Rectangle(player.x-6, player.y-6, 12, 12);
  for (const o of objs){
    const r = new Phaser.Geom.Rectangle(o.x, o.y, o.width, o.height);
    if (Phaser.Geom.Rectangle.Overlaps(rect, r)) return o;
  }
  return null;
}

function useAction(){
  const o = getHoverObject();
  if (!o || o.type!=='field') return;
  const cell = map.tileWidth;
  const cx = Math.floor((player.x - o.x)/cell);
  const cy = Math.floor((player.y - o.y)/cell);
  const tx = Math.floor(o.x/cell) + Phaser.Math.Clamp(cx,0,2);
  const ty = Math.floor(o.y/cell) + Phaser.Math.Clamp(cy,0,2);
  const tile = fields.getTileAt(tx, ty, true);
  if (tile.index === 8 && seeds>0){ fields.putTileAt(10, tx, ty); seeds--; }
  else if (tile.index === 10){ fields.putTileAt(11, tx, ty); }
  else if (tile.index === 11){ fields.putTileAt(12, tx, ty); }
  else if (tile.index === 12){ fields.putTileAt(8, tx, ty); coins+=2; seeds+=1; }
  updateHUD();
}

function interactAction(){
  const o = getHoverObject();
  if (!o) return;
  // Add more interactions later
}

function update(){
  const speed = 90;
  let vx=0, vy=0;
  if (this.input.keyboard.addKey('W').isDown || cursors.up.isDown) vy -= 1;
  if (this.input.keyboard.addKey('S').isDown || cursors.down.isDown) vy += 1;
  if (this.input.keyboard.addKey('A').isDown || cursors.left.isDown) vx -= 1;
  if (this.input.keyboard.addKey('D').isDown || cursors.right.isDown) vx += 1;
  if (joyVec.x||joyVec.y){ vx += joyVec.x; vy += joyVec.y; }
  const m = Math.hypot(vx,vy)||1; vx/=m; vy/=m;
  player.body.setVelocity(vx*speed, vy*speed);

  timeOfDay += this.game.loop.delta/1000 * 0.25;
  if (timeOfDay>=24){ day++; timeOfDay=8.0; }
  updateHUD();

  const o = getHoverObject();
  promptEl.textContent = o ? (o.type==='field' ? 'Feld – [●] säen/ernten' : (o.name+' – [E] interagieren')) : '';
}

function updateHUD(){
  document.getElementById('cDay').textContent = 'Tag ' + day;
  document.getElementById('cTime').textContent = 'Zeit ' + timeOfDay.toFixed(1) + 'h';
  document.getElementById('cInv').textContent = 'Samen ' + seeds + ' • Holz ' + wood + ' • Münzen ' + coins;
}
</script>
</body>
</html>
